<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32WifiPhisher</title>
    <style>
        :root {
            --bg-color: #0f0f0f;
            --sidebar-bg: #141414;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #6c757d;
            --accent: #00e676;
            --accent-dim: rgba(0, 230, 118, 0.1);
            --danger: #ff5252;
            --border: #333;
            --terminal-bg: #000000;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px;
            background-color: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .brand {
            padding: 25px 20px;
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--accent);
            letter-spacing: 1px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 0 10px rgba(0, 230, 118, 0.4);
        }

        .menu {
            flex: 1;
            overflow-y: auto;
            padding: 20px 0;
        }

        .menu-category {
            padding: 20px 25px 8px 25px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-muted);
            letter-spacing: 1.2px;
            user-select: none;
        }

        .menu-item {
            padding: 12px 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            color: #bbb;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .menu-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .menu-item.active {
            background-color: var(--accent-dim);
            color: var(--accent);
            border-left: 3px solid var(--accent);
        }

        .menu-item svg {
            width: 20px;
            height: 20px;
            margin-right: 15px;
            fill: currentColor;
        }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-color);
            position: relative;
        }

        /* --- TOP BAR --- */
        .top-bar {
            height: 60px;
            background-color: var(--sidebar-bg);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
        }

        .page-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .status-indicators {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            align-items: center;
        }

        /* RAM Bar Style */
        .ram-container {
            display: flex;
            flex-direction: column;
            width: 100px;
        }

        .ram-text {
            font-size: 0.75rem;
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
            color: #aaa;
        }

        .progress-bg {
            width: 100%;
            height: 4px;
            background: #333;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.5s ease;
            box-shadow: 0 0 8px var(--accent);
        }

        .status-badge {
            background: #333;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            border: 1px solid #444;
        }

        .status-value {
            color: var(--accent);
            font-weight: bold;
        }

        .mobile-toggle {
            display: none;
            cursor: pointer;
            font-size: 1.5rem;
            color: white;
        }

        /* --- VIEWS --- */
        .view-container {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: none;
            padding-bottom: 150px;
            /* Space for terminal */
        }

        .view-container.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h2 {
            color: white;
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
            margin-top: 0;
            font-weight: 300;
            letter-spacing: 1px;
        }

        /* --- CARDS & UI --- */
        .card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
        }

        .stat-label {
            color: #aaa;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
            font-size: 0.85rem;
            margin-top: 15px;
            text-transform: uppercase;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 12px;
            background-color: #121212;
            border: 1px solid #444;
            color: white;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
            transition: border 0.2s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            background-color: var(--accent);
            color: #000;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 1px;
            transition: all 0.2s;
        }

        button:hover {
            filter: brightness(1.1);
            box-shadow: 0 0 15px var(--accent-dim);
        }

        button:active {
            transform: scale(0.98);
        }

        button.danger {
            background-color: var(--danger);
            color: white;
        }

        button.danger:hover {
            box-shadow: 0 0 15px rgba(255, 82, 82, 0.2);
        }

        button.secondary {
            background-color: #333;
            color: white;
            border: 1px solid #444;
        }

        .wifi-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            color: #ccc;
            white-space: nowrap;
        }

        .wifi-table th {
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid #444;
            color: #888;
            text-transform: uppercase;
            font-size: 0.75rem;
        }

        .wifi-table td {
            border-bottom: 1px solid #333;
            padding: 12px;
        }

        .wifi-table tr:hover {
            background-color: #2a2a2a;
        }

        /* --- TERMINAL WINDOW (New) --- */
        .terminal-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 140px;
            background-color: var(--terminal-bg);
            border-top: 1px solid var(--accent);
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #0f0;
            overflow-y: auto;
            z-index: 500;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
        }

        .log-entry {
            margin: 2px 0;
        }

        .log-time {
            color: #666;
            margin-right: 10px;
        }

        .log-info {
            color: #00e676;
        }

        .log-error {
            color: #ff5252;
        }

        .log-success {
            color: #00e676;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(0, 230, 118, 0.5);
        }
        
        .log-warning {
            color: #ffab40;
        }

        /* --- TOAST NOTIFICATION (New) --- */
        .toast {
            position: absolute;
            top: 80px;
            right: 20px;
            background-color: #333;
            border-left: 4px solid var(--accent);
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            transform: translateX(200%);
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            z-index: 2000;
        }

        .toast.show {
            transform: translateX(0);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                height: 100%;
                transform: translateX(-100%);
                box-shadow: 5px 0 15px rgba(0, 0, 0, 0.5);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .mobile-toggle {
                display: block;
            }

            .view-container {
                padding: 15px;
                padding-bottom: 160px;
            }

            .status-indicators {
                display: none;
            }

            /* --- EFFECTIVENESS BADGES --- */
            .impact-badge {
                display: inline-block;
                padding: 4px 12px;
                border-radius: 4px;
                font-size: 0.75rem;
                font-weight: 800;
                text-transform: uppercase;
                letter-spacing: 1px;
                margin-bottom: 8px;
                border: 1px solid rgba(255,255,255,0.2);
            }

            .impact-low {
                background-color: rgba(108, 117, 125, 0.2);
                color: #adb5bd;
                border-color: #adb5bd;
            }

            .impact-medium {
                background-color: rgba(255, 171, 64, 0.2);
                color: #ffab40;
                border-color: #ffab40;
            }

            .impact-high {
                background-color: rgba(255, 82, 82, 0.2);
                color: #ff5252;
                border-color: #ff5252;
            }

            .impact-critical {
                background-color: rgba(255, 0, 0, 0.3);
                color: #ff0000;
                border-color: #ff0000;
                box-shadow: 0 0 10px rgba(255, 0, 0, 0.4);
                animation: pulse-red 2s infinite;
            }

            @keyframes pulse-red {
                0% { box-shadow: 0 0 5px rgba(255, 0, 0, 0.2); }
                50% { box-shadow: 0 0 15px rgba(255, 0, 0, 0.6); }
                100% { box-shadow: 0 0 5px rgba(255, 0, 0, 0.2); }
            }

            /* Hide status on mobile top bar */
        }
    </style>
</head>

<body>

    <div class="sidebar" id="sidebar">
        <div class="brand">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path
                    d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z" />
            </svg>
            <span>ESP32 审计</span>
        </div>
        <div class="menu">
            <div class="menu-category">仪表板</div>
            <div class="menu-item active" onclick="showView('view-home', this)">
                <svg viewBox="0 0 24 24">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
                </svg> 状态概览
            </div>
            <div class="menu-category">WiFi 模块</div>
            <div class="menu-item" onclick="showView('view-sniffer', this)">
                <svg viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                </svg> 数据包分析器
            </div>
            <div class="menu-item" onclick="showView('view-scan', this)">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M12.01 21.49L23.64 7c-.45-.34-4.93-4-11.64-4C5.28 3 .81 6.66.36 7l11.63 14.49.01.01.01-.01z" />
                </svg> 扫描和嗅探
            </div>
            <div class="menu-item" onclick="showView('view-eviltwin', this)">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z" />
                </svg> 邪恶孪生攻击
            </div>
            <div class="menu-item" onclick="showView('view-karma', this)">
                <svg viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                </svg> 因果攻击
            </div>
            <div class="menu-item" onclick="showView('view-deauth', this)">
                <svg viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM4 12c0-4.42 3.58-8 8-8 1.85 0 3.55.63 4.9 1.69L5.69 16.9C4.63 15.55 4 13.85 4 12zm8 8c-1.85 0-3.55-.63-4.9-1.69L18.31 7.1C19.37 8.45 20 10.15 20 12c0 4.42-3.58 8-8 8z"/>
                </svg> 断开认证
            </div>
            <div class="menu-category">系统</div>
            <div class="menu-item" onclick="showView('view-passwords', this)">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z" />
                </svg> 已捕获凭证
            </div>
            <div class="menu-item" onclick="showView('view-settings', this)">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
                </svg> 配置
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div class="mobile-toggle" onclick="toggleSidebar()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
                </svg>
            </div>
            <div class="page-title" id="page-title">状态概览</div>

            <div class="status-indicators">
                <div class="status-badge">运行时间 <span class="status-value" id="uptime-val">--:--:--</span></div>

                <div class="ram-container">
                    <div class="ram-text"><span>内存</span> <span id="ram-text-val">0%</span></div>
                    <div class="progress-bg">
                        <div class="progress-fill" id="ram-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="status-badge">SD卡 <span class="status-value" id="status-sd">--</span></div>
            </div>
        </div>

        <div id="toast" class="toast">Notification Message</div>

        <div id="view-home" class="view-container active">
            <div style="display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 20px;">
                <h2 style="border:none; padding:0; margin:0;">仪表板</h2>
                <div id="global-status-badge" style="background:#333; color:#aaa; padding:5px 12px; border-radius:4px; font-size:0.8rem; font-weight:bold; border:1px solid #444;">
                    系统就绪
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px;">
                <div id="mod-et" style="background:#121212; border:1px solid #333; padding:15px; border-radius:6px; text-align:center; transition:all 0.3s;">
                    <div style="font-size:0.75rem; color:#666; font-weight:bold;">邪恶孪生</div>
                    <div class="mod-status" style="font-size:1rem; font-weight:bold; color:#444; margin-top:5px;">未激活</div>
                </div>
                <div id="mod-deauth" style="background:#121212; border:1px solid #333; padding:15px; border-radius:6px; text-align:center; transition:all 0.3s;">
                    <div style="font-size:0.75rem; color:#666; font-weight:bold;">断开认证</div>
                    <div class="mod-status" style="font-size:1rem; font-weight:bold; color:#444; margin-top:5px;">未激活</div>
                </div>
                <div id="mod-karma" style="background:#121212; border:1px solid #333; padding:15px; border-radius:6px; text-align:center; transition:all 0.3s;">
                    <div style="font-size:0.75rem; color:#666; font-weight:bold;">因果</div>
                    <div class="mod-status" style="font-size:1rem; font-weight:bold; color:#444; margin-top:5px;">未激活</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                
                <div class="card" style="border-top: 3px solid var(--accent); position: relative;">
                    <div class="stat-label">目标信息</div>
                    
                    <div style="margin-top: 15px;">
                        <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                            <div id="home-ssid" style="font-size: 1.5rem; font-weight: bold; color: white; line-height:1.2; word-break: break-all;">未选择目标</div>
                            <div id="home-rssi" style="font-size: 0.9rem; color: #666; font-weight:bold; white-space: nowrap;">-- dBm</div>
                        </div>
                        
                        <div style="margin-top:15px; display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:0.85rem;">
                            <div style="background:#121212; padding:10px; border-radius:4px; border:1px solid #333;">
                                <span style="color:#666; display:block; font-size:0.65rem; margin-bottom:2px;">MAC地址</span>
                                <span id="home-bssid" style="font-family:monospace; color:#ccc; letter-spacing:1px;">--:--:--:--:--:--</span>
                            </div>
                            <div style="background:#121212; padding:10px; border-radius:4px; border:1px solid #333;">
                                <span style="color:#666; display:block; font-size:0.65rem; margin-bottom:2px;">厂商</span>
                                <span id="home-vendor" style="color:#ccc;">--</span>
                            </div>
                            <div style="background:#121212; padding:10px; border-radius:4px; border:1px solid #333;">
                                <span style="color:#666; display:block; font-size:0.65rem; margin-bottom:2px;">频道</span>
                                <span id="home-ch" style="color:var(--accent); font-weight:bold; font-size:1.1rem;">--</span>
                            </div>
                            <div style="background:#121212; padding:10px; border-radius:4px; border:1px solid #333;">
                                <span style="color:#666; display:block; font-size:0.65rem; margin-bottom:2px;">安全</span>
                                <span id="home-auth" style="color:#ccc;">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="border-top: 3px solid #ff5252;">
                    <div class="stat-label">情报和捕获</div>
                    
                    <div style="margin-top:20px; display:flex; flex-direction:column; gap:15px;">
                        <div style="display:flex; align-items:center; justify-content:space-between; padding-bottom:10px; border-bottom:1px solid #333;">
                            <div>
                                <div style="font-size:0.85rem; font-weight:bold; color:#fff;">WPA握手</div>
                                <div style="font-size:0.75rem; color:#888;">哈希收集</div>
                            </div>
                            <div id="home-hs-badge" style="background:#222; color:#555; padding:4px 10px; border-radius:4px; font-size:0.7rem; font-weight:bold; letter-spacing:1px;">
                                等待
                            </div>
                        </div>

                        <div style="display:flex; align-items:center; justify-content:space-between; padding-bottom:10px; border-bottom:1px solid #333;">
                            <div>
                                <div style="font-size:0.85rem; font-weight:bold; color:#fff;">5GHz 孪生</div>
                                <div style="font-size:0.75rem; color:#888;">双频AP检测</div>
                            </div>
                            <div id="home-5g-badge" style="background:#222; color:#555; padding:4px 10px; border-radius:4px; font-size:0.7rem; font-weight:bold; letter-spacing:1px;">
                                扫描中
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px;">
                            <div style="text-align:center; background:#1a1a1a; padding:10px; border-radius:4px;">
                                <div id="home-clients" style="font-size: 1.5rem; font-weight:bold; color: #fff;">0</div>
                                <div style="font-size: 0.7rem; color: #00bcd4; font-weight:bold;">客户端</div>
                            </div>
                            <div style="text-align:center; background:#1a1a1a; padding:10px; border-radius:4px;">
                                <div id="home-aps" style="font-size: 1.5rem; font-weight:bold; color: #fff;">0</div>
                                <div style="font-size: 0.7rem; color: #aaa; font-weight:bold;">网络</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="border-top: 3px solid #00e676;">
                    <div class="stat-label">包注射健康度</div>
                    
                    <div style="margin-top: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div style="text-align: center; background: #151515; padding: 10px; border-radius: 4px;">
                                <div id="stat-tx-sent" style="font-size: 1.8rem; font-weight: bold; color: white;">0</div>
                                <div style="font-size: 0.7rem; color: #aaa; letter-spacing: 1px;">已发送</div>
                            </div>
                            <div style="text-align: center; background: #151515; padding: 10px; border-radius: 4px;">
                                <div id="stat-tx-drop" style="font-size: 1.8rem; font-weight: bold; color: #ff5252;">0</div>
                                <div style="font-size: 0.7rem; color: #aaa; letter-spacing: 1px;">丢弃</div>
                            </div>
                        </div>

                        <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: #aaa; margin-bottom: 5px;">
                            <span>注射质量</span>
                            <span id="stat-quality-perc">100%</span>
                        </div>
                        <div class="progress-bg" style="background: #333; height: 6px;">
                            <div id="stat-quality-bar" class="progress-fill" style="width: 100%; background: #00e676;"></div>
                        </div>
                        <div id="stat-message" style="font-size: 0.7rem; color: #666; margin-top: 8px; font-style: italic;">
                            系统空闲。
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-sniffer" class="view-container">
            <h2>实时数据包分析器</h2>
            
            <div class="card">
                <label style="color:var(--accent); border-bottom:1px solid #333; padding-bottom:5px; margin-bottom:15px; margin-top:0;">捕获配置</label>
                
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:20px;">
                    <div>
                        <label>频率</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <select id="sniff-chan" style="flex:1;">
                                </select>
                            <div style="display:flex; align-items:center; gap:5px; background:#121212; padding:8px; border:1px solid #444; border-radius:4px; height: 42px; box-sizing: border-box;">
                                <input type="checkbox" id="sniff-hop" style="width:auto; margin:0;">
                                <span style="font-size:0.8rem; color:#aaa; font-weight:bold;">跳跃</span>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label>主要帧类型</label>
                        <select id="sniff-type" onchange="updateSubtypes()">
                            <option value="0">所有流量</option>
                            <option value="1">管理</option>
                            <option value="2">控制</option>
                            <option value="3">数据</option>
                        </select>
                    </div>

                    <div>
                        <label>子类型过滤器</label>
                        <select id="sniff-subtype" disabled>
                            <option value="0">所有子类型</option>
                        </select>
                    </div>
                </div>

                <label style="color:var(--accent); border-bottom:1px solid #333; padding-bottom:5px; margin-bottom:15px;">显示过滤器</label>
                
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:10px; margin-bottom:15px;">
                    <input type="text" id="disp-filter-src" placeholder="源 MAC">
                    <input type="text" id="disp-filter-dst" placeholder="目标 MAC">
                    <input type="text" id="disp-filter-ssid" placeholder="SSID / 信息">
                    <input type="number" id="disp-filter-rssi" placeholder="最小 RSSI (-90)" value="-95">
                </div>
                
                <div class="btn-group">
                    <button onclick="startCapture()" id="btn-sniff-start">
                        <svg style="width:16px; height:16px; vertical-align:middle; margin-right:5px;" viewBox="0 0 24 24"><path fill="currentColor" d="M8 5v14l11-7z"/></svg> 启动
                    </button>
                    
                    <button class="danger" onclick="stopCapture()" id="btn-sniff-stop" disabled style="opacity:0.5; cursor:not-allowed;">
                        <svg style="width:16px; height:16px; vertical-align:middle; margin-right:5px;" viewBox="0 0 24 24"><path fill="currentColor" d="M6 6h12v12H6z"/></svg> 停止
                    </button>

                    <button class="secondary" onclick="togglePause()" id="btn-sniff-pause">暂停视图</button>
                    <button class="secondary" onclick="clearSnifferTable()">清除</button>
                </div>
                
                <div style="margin-top:5px; font-size:0.8rem; color:#666; text-align:right;">
                    接收: <span id="pkt-total-count">0</span> | 显示: <span id="pkt-display-count">0</span>
                </div>
            </div>

            <div class="card" style="padding:0; overflow-x:auto; height: 500px; overflow-y: scroll;">
                <table class="wifi-table" style="font-family: 'Courier New', monospace; font-size: 0.8rem;">
                    <thead style="position: sticky; top: 0; background: #1e1e1e; z-index: 10;">
                        <tr>
                            <th style="width:40px">信道</th>
                            <th style="width:50px">dBm</th>
                            <th style="width:60px">类型</th>
                            <th style="width:100px">子类型</th>
                            <th style="width:130px">源</th>
                            <th style="width:130px">目标</th>
                            <th style="width:40px">长度</th>
                            <th>信息</th>
                        </tr>
                    </thead>
                    <tbody id="sniffer-body"></tbody>
                </table>
            </div>
        </div>

        <div id="view-scan" class="view-container">
            <h2>WiFi 扫描器</h2>
            <div class="card">
                <p style="margin-top:0;">扫描附近的接入点以选择目标。</p>
                <div class="btn-group">
                    <button onclick="scanNetworks()">开始扫描</button>
                </div>
            </div>
            <div id="network-list" class="card" style="padding:0; overflow-x:auto;">
                <table class="wifi-table">
                    <thead>
                        <tr>
                            <th>SSID</th>
                            <th>信号</th>
                            <th>信道</th>
                            <th>BSSID</th>
                            <th>安全</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="wifi-networks-body">
                        <tr>
                            <td colspan="6" style="text-align:center; padding: 20px;">无扫描数据</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="view-eviltwin" class="view-container">
            <h2>邪恶孪生攻击</h2>
            <div class="card">
                <label>攻击场景</label>
                <select id="attack-scenario">
                    <option value="0">固件升级</option>
                    <option value="1">假网络管理器</option>
                    <option value="2">OAuth 登录</option>
                </select>

                <div
                    style="margin-top: 20px; border: 1px dashed #444; padding: 15px; border-radius: 4px; background:#181818;">
                    <label style="margin-top:0;">目标详情</label>
                    <div style="font-size: 1.2rem; color: var(--accent); font-weight:bold;" id="current-target-ssid">未选择目标
                    </div>
                    <div style="font-family:monospace; color: #666;" id="current-target-bssid">--:--:--:--:--:--</div>
                </div>

                <div class="btn-group">
                    <button class="danger" onclick="startEvilTwin()">启动攻击</button>
                    <button class="secondary" onclick="stopEvilTwin()">终止</button>
                </div>
            </div>
        </div>

        <div id="view-karma" class="view-container">
            <h2>因果探针扫描器</h2>
            
            <div class="card">
                <label>1. 网络钓鱼场景</label>
                <select id="karma-scenario">
                    <option value="0">固件升级</option>
                    <option value="1">假网络管理器</option>
                    <option value="2">OAuth 登录</option>
                </select>

                <p style="margin-top:15px; font-size:0.9rem; color:#aaa;">
                    2. 扫描正在探测已知网络的设备。
                </p>

                <div class="btn-group">
                    <button onclick="startKarmaScan()">扫描探针</button>
                    <button class="secondary" onclick="stopKarmaScan()">停止扫描</button>
                </div>
            </div>

            <div class="card" style="padding:0; overflow-x:auto;">
                <div style="padding:15px; border-bottom:1px solid #333; font-weight:bold; color:var(--accent);">
                    检测到的探针
                </div>
                <table class="wifi-table">
                    <thead>
                        <tr>
                            <th>受害者 MAC</th>
                            <th>目标 SSID</th>
                            <th>RSSI</th>
                            <th>信道</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="karma-scan-body">
                        <tr>
                            <td colspan="5" style="text-align:center; padding: 20px; color:#666;">
                                点击"扫描探针"开始监听...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="view-deauth" class="view-container">
            <h2>断开认证攻击</h2>
            
            <div class="card">
                <label>目标模式</label>
                <select id="deauth-mode" onchange="updateDeauthUI()">
                    <option value="single">单个目标（选定的SSID）</option>
                    <option value="broadcast">所有网络（广播/跳跃）</option>
                </select>

                <div id="deauth-info-box" style="margin-top: 15px; margin-bottom: 20px; border: 1px dashed var(--danger); padding: 15px; border-radius: 4px; background:rgba(255, 82, 82, 0.05);">
                    <label style="margin-top:0; color:var(--danger);">当前目标</label>
                    <div style="font-size: 1.3rem; font-weight:bold; color:white;" id="deauth-target-ssid">未选择目标</div>
                    <div style="font-family:monospace; color: #888;" id="deauth-target-bssid">--:--:--:--:--:--</div>
                    <div style="font-size: 0.8rem; color: #666; margin-top:5px;">信道: <span id="deauth-target-ch">--</span></div>
                </div>

                <div>
                    <label>攻击类型</label>
                    <select id="deauth-frame-type" onchange="updateAttackTypeDesc()">
                        <option value="0" selected>断开认证帧</option>
                        <option value="1">解除关联帧</option>
                        <option value="2">广播断开认证/解除关联</option>
                        <option value="3">认证泛洪</option>
                        <option value="4">关联/重新关联泛洪</option>
                        <option value="5">CSA欺骗</option>
                        <option value="6">EAPOL-注销欺骗</option>
                        <option value="7">EAPOL-启动垃圾信息</option>
                        <option value="8">EAP失败注入</option>
                        <option value="9">EAP身份请求垃圾/EAP轮次滥用</option>
                        <option value="10">4-路握手中断</option>
                        <option value="11">WPA3 SAE泛洪</option>
                        <option value="12">PMF/802.11w降级压力</option>
                        <option value="13">NAV/RTS/CTS滥用</option>
                        <option value="14">信标操纵</option>
                    </select>

                    <div id="attack-meta" style="margin-top: 15px;"></div>
                    
                    <div id="attack-desc" style="margin-top: 10px; padding: 10px; background: #121212; border-left: 3px solid var(--accent); color: #aaa; font-size: 0.85rem; font-style: italic; min-height: 40px;">
                    </div>
                </div>
                
                <p style="font-size: 0.8rem; color: #666; margin-top: 20px;">
                    <strong style="color:var(--danger)">警告:</strong> 
                    <span id="deauth-warning-text">这将断开客户端与所选接入点的连接。</span>
                </p>

                <div class="btn-group">
                    <button class="danger" onclick="startDeauth()">启动攻击</button>
                    <button class="secondary" onclick="stopDeauth()">停止</button>
                </div>
            </div>

            <div class="terminal-panel" style="position: relative; height: 100px; margin-top:20px; border: 1px solid #333; box-shadow:none;">
                <div class="log-entry"><span class="log-time">信息</span> 选择"所有网络"或从扫描器选择目标。</div>
            </div>
        </div>

        <div id="view-passwords" class="view-container">
            <h2>已捕获凭证</h2>
            <div class="card">
                <textarea id="passwords-textarea" readonly
                    style="height: 350px; background-color: #000; color:#0f0; border:none;"></textarea>
                <div class="btn-group">
                    <button onclick="fetchPasswords()">刷新</button>
                    <button class="secondary"
                        onclick="document.getElementById('passwords-textarea').value=''">清除</button>
                </div>
            </div>
        </div>

        <div id="view-settings" class="view-container">
            <h2>配置</h2>
            <div class="card">
                <form id="hotspot-form" onsubmit="handleSettings(event)">
                    <label>管理 AP SSID</label>
                    <input type="text" id="ssid" name="ssid">
                    <label>密码</label>
                    <input type="text" id="password" name="password">
                    <label>信道</label>
                    <input type="number" id="channel" name="channel" min="1" max="13">
                    <div class="btn-group">
                        <button type="submit">保存并重启</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="terminal-panel" id="terminal">
            <div class="log-entry"><span class="log-time">[系统]</span> <span class="log-info">就绪。</span></div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURAZIONE & COSTANTI
        // ==========================================
        const WS_URL = `ws://192.168.4.1/ws`;
        
        const CMD = {
            GET_STATUS: 0,
            SET_AP_SETTINGS: 1,
            GET_AP_SETTINGS: 2,
            WIFI_SCAN: 3,
            START_EVILTWIN: 4,
            STOP_EVILTWIN: 5,
            GET_EVILTWIN_TARGET: 6,
            CHECK_INPUT_PASSWORD: 7,
            GET_PASSWORDS: 8,
            KARMA_ATTACK_SCAN: 9,
            GET_KARMA_PROBES: 10,
            KARMA_ATTACK_START: 11,
            START_DEAUTHER: 12,
            STOP_DEAUTHER: 13,
            START_RAW_SNIFFER: 14,
            STOP_RAW_SNIFFER: 15
        };

        // Stato globale
        let ws = null;
        let reqIdCounter = 0;
        let pendingRequests = new Map();
        let isConnected = false;
        let statusInterval = null;
        let currentTarget = null;
        let karmaInterval = null;

        // Packet sniffer
        let snifferActive = false;
        let isSnifferPaused = false;
        let totalPacketsRx = 0;
        let displayedPackets = 0;
        const SUBTYPES = {
            1: [ // MANAGEMENT (Enum libwifi_mgmt_subtypes) -> val = enum << 4
                { name: "All Management", val: 0xFFFF },
                { name: "Assoc Req (0)", val: 0x00 },          // SUBTYPE_ASSOC_REQ
                { name: "Assoc Resp (1)", val: 0x10 },         // SUBTYPE_ASSOC_RESP
                { name: "Reassoc Req (2)", val: 0x20 },        // SUBTYPE_REASSOC_REQ
                { name: "Reassoc Resp (3)", val: 0x30 },       // SUBTYPE_REASSOC_RESP
                { name: "Probe Req (4)", val: 0x40 },          // SUBTYPE_PROBE_REQ
                { name: "Probe Resp (5)", val: 0x50 },         // SUBTYPE_PROBE_RESP
                { name: "Timing Adv (6)", val: 0x60 },         // SUBTYPE_TIME_ADV
                { name: "Beacon (8)", val: 0x80 },             // SUBTYPE_BEACON
                { name: "ATIM (9)", val: 0x90 },               // SUBTYPE_ATIM
                { name: "Disassoc (10)", val: 0xA0 },          // SUBTYPE_DISASSOC
                { name: "Auth (11)", val: 0xB0 },              // SUBTYPE_AUTH
                { name: "Deauth (12)", val: 0xC0 },            // SUBTYPE_DEAUTH
                { name: "Action (13)", val: 0xD0 },            // SUBTYPE_ACTION
                { name: "Action No Ack (14)", val: 0xE0 }      // SUBTYPE_ACTION_NOACK
            ],
            2: [ // CONTROL (Mappatura su Filtri Hardware ESP32)
                { name: "All Control", val: 0xFFFFFFFF },
                { name: "RTS (11)", val: (1<<27) },            // SUBTYPE_RTS
                { name: "CTS (12)", val: (1<<28) },            // SUBTYPE_CTS
                { name: "ACK (13)", val: (1<<29) },            // SUBTYPE_ACK
                { name: "Block Ack Req (8)", val: (1<<24) },   // SUBTYPE_BLOCK_ACK_REQ
                { name: "Block Ack (9)", val: (1<<25) },       // SUBTYPE_BLOCK_ACK
                { name: "PS-Poll (10)", val: (1<<26) },        // SUBTYPE_PS_POLL
                { name: "CF-End (14)", val: (1<<30) },         // SUBTYPE_CF_END
                { name: "CF-End+Ack (15)", val: (1<<31) },     // SUBTYPE_CF_END_CF_ACK
                { name: "Wrapper (7)", val: (1<<23) }          // SUBTYPE_WRAPPER
            ],
            3: [ // DATA (Enum libwifi_data_subtypes) -> val = enum << 4
                { name: "All Data", val: 0xFFFF },
                { name: "Data (0)", val: 0x00 },               // SUBTYPE_DATA
                { name: "Data Null (4)", val: 0x40 },          // SUBTYPE_DATA_NULL
                { name: "QoS Data (8)", val: 0x80 },           // SUBTYPE_DATA_QOS_DATA
                { name: "QoS Data CF-Ack (9)", val: 0x90 },    // SUBTYPE_DATA_QOS_DATA_CF_ACK
                { name: "QoS Data CF-Poll (10)", val: 0xA0 },  // SUBTYPE_DATA_QOS_DATA_CF_POLL
                { name: "QoS Data CF-Ack+Poll (11)", val: 0xB0 }, // SUBTYPE_DATA_QOS_DATA_CF_ACK_CF_POLL
                { name: "QoS Null (12)", val: 0xC0 },          // SUBTYPE_DATA_QOS_NULL
                { name: "QoS CF-Poll (14)", val: 0xE0 },       // SUBTYPE_DATA_QOS_CF_POLL
                { name: "QoS CF-Ack+Poll (15)", val: 0xF0 }    // SUBTYPE_DATA_QOS_CF_ACK_CF_POLL
            ]
        };

        // ==========================================
        // LOGGER & UI UTILS
        // ==========================================
        function log(msg, type = 'info') {
            const term = document.getElementById('terminal');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            // Mappa i livelli del C alle classi CSS
            let colorClass = 'log-info';
            if (type === 'error') colorClass = 'log-error';
            else if (type === 'success') colorClass = 'log-success';
            else if (type === 'warning') colorClass = 'log-warning';

            const time = new Date().toLocaleTimeString().split(' ')[0];
            entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="${colorClass}">${msg}</span>`;
            
            term.appendChild(entry);
            if (term.scrollHeight - term.scrollTop <= term.clientHeight + 50) {
                term.scrollTop = term.scrollHeight; 
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function toggleSidebar() { 
            document.getElementById('sidebar').classList.toggle('open'); 
        }

        function showView(viewId, menuItem) {
            document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            menuItem.classList.add('active');
            document.getElementById('page-title').innerText = menuItem.innerText.trim();
            
            if (window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('open');
            if (viewId === 'view-settings') loadApSettings();
            if (viewId === 'view-passwords') fetchPasswords();
            if (viewId === 'view-deauth') updateDeauthUI();
            if (viewId !== 'view-karma' && karmaInterval) {
                clearInterval(karmaInterval);
                karmaInterval = null;
            }
        }

        function updateAttackTypeDesc() {
            const type = document.getElementById('deauth-frame-type').value;
            const descEl = document.getElementById('attack-desc');
            const metaEl = document.getElementById('attack-meta');

            // Configurazione dati attacchi
            const attackData = {
                "0": { // 断开认证
                    level: "低 / 中",
                    cls: "impact-medium",
                    desc: "发送 <b>802.11 断开认证</b> 帧。对传统网络有效。被 WPA3/PMF 完全阻止。"
                },
                "1": { // 解除关联
                    level: "低 / 中",
                    cls: "impact-medium",
                    desc: "发送 <b>802.11 解除关联</b> 帧。强制重新关联。被 PMF 阻止。"
                },
                "2": { // 广播
                    level: "高",
                    cls: "impact-high",
                    desc: "使用 <b>广播</b> 断开认证帧。可以瞬间破坏整个非 PMF 网络。极其嘈杂。"
                },
                "3": { // 认证泛洪
                    level: "中",
                    cls: "impact-medium",
                    desc: "<b>认证泛洪</b>：压倒 AP 状态表。可以冻结廉价路由器，但现代 AP 会限制这个。"
                },
                "4": { // 关联泛洪
                    level: "高",
                    cls: "impact-high",
                    desc: "<b>关联泛洪</b>：消耗 AP 内存/客户端槽位。对消费者路由器有效的 DoS。"
                },
                "5": { // CSA 欺骗
                    level: "严重",
                    cls: "impact-critical",
                    desc: "<b>CSA 欺骗</b>：强制客户端立即切换频道。即使在某些 PMF 网络上也会导致瞬间断开。"
                },
                "6": { // EAPOL 注销
                    level: "低",
                    cls: "impact-low",
                    desc: "<b>EAPOL-注销</b>：特定于 WPA-企业。仅在不验证帧状态的实现上工作。"
                },
                "7": { // EAPOL 启动
                    level: "中",
                    cls: "impact-medium",
                    desc: "<b>EAPOL-启动垃圾信息</b>：通过启动许多虚假握手会话来压力 AP CPU。"
                },
                "8": { // EAP 失败
                    level: "中",
                    cls: "impact-medium",
                    desc: "<b>EAP 失败</b>：可以在中途中止认证过程。在连接阶段有效。"
                },
                "9": { // EAP ID
                    level: "低",
                    cls: "impact-low",
                    desc: "<b>EAP 身份垃圾信息</b>：轻微骚扰，保持客户端/AP 忙于回答身份请求。"
                },
                "10": { // 握手
                    level: "低",
                    cls: "impact-low",
                    desc: "<b>握手中断</b>：精准的拒绝服务。阻止客户端完成 4-路握手。"
                },
                "11": { // WPA3 SAE
                    level: "低",
                    cls: "impact-low",
                    desc: "<b>WPA3 SAE 泛洪</b>：密码学 DoS。通过强制重计算来耗尽 AP CPU。对 WPA3 AP 致命。"
                },
                "12": { // PMF 降级
                    level: "低",
                    cls: "impact-low",
                    desc: "<b>PMF 降级</b>：试图强制传统模式。在现代配置的网络上成功率低。"
                },
                "13": { // NAV 滥用
                    level: "高",
                    cls: "impact-high",
                    desc: "<b>NAV 滥用（广播）</b>：通过保留空中时间（32ms）来逻辑干扰网络。虚拟干扰。"
                },
                "14": { // 信标操纵
                    level: "严重 / 致命",
                    cls: "impact-critical",
                    desc: "<b>信标管制滥用</b>：利用 802.11h/合规性。强制客户端降低功率或切换频道。<br><b>绕过 PMF。高度有效。</b>"
                }
            };

            const data = attackData[type] || { level: "UNKNOWN", cls: "impact-low", desc: "Select an attack." };

            // Update Badge
            metaEl.innerHTML = `<span class="impact-badge ${data.cls}">EFFECTIVENESS: ${data.level}</span>`;
            
            // Update Description
            descEl.innerHTML = data.desc;
            
            // Cambia il colore del bordo del box descrizione in base alla pericolosità
            const borderColors = {
                "impact-low": "#adb5bd",
                "impact-medium": "#ffab40",
                "impact-high": "#ff5252",
                "impact-critical": "#ff0000"
            };
            descEl.style.borderLeftColor = borderColors[data.cls];
        }
        
        function formatBigNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
            return num.toString();
        }
        
        //Sniffer Functions
        function handlePacket(pkt) {
            // Risparmia CPU se la vista non è attiva
            if(!document.getElementById('view-sniffer').classList.contains('active')) return;

            totalPacketsRx++;
            
            // Se in pausa, aggiorna solo i contatori ma non la tabella DOM
            if (isSnifferPaused) {
                updateCounters();
                return;
            }

            // --- FILTRI BROWSER (DISPLAY) ---
            // 1. RSSI Minimo
            const minRssi = parseInt(document.getElementById('disp-filter-rssi').value) || -100;
            if(pkt.rssi < minRssi) { updateCounters(); return; }

            // 2. Source MAC (parziale)
            const fSrc = document.getElementById('disp-filter-src').value.trim().toUpperCase();
            if(fSrc && !pkt.src.includes(fSrc)) { updateCounters(); return; }

            // 3. Destination MAC (parziale)
            const fDst = document.getElementById('disp-filter-dst').value.trim().toUpperCase();
            if(fDst && !pkt.dst.includes(fDst)) { updateCounters(); return; }

            // 4. SSID / Info Text
            const fSsid = document.getElementById('disp-filter-ssid').value.trim().toUpperCase();
            if(fSsid && !pkt.info.toUpperCase().includes(fSsid)) { updateCounters(); return; }

            // --- RENDERING TABELLA ---
            displayedPackets++;
            const tbody = document.getElementById('sniffer-body');
            const row = document.createElement('tr');
            
            // Logica Colori
            let color = "#bbb";
            let bgColor = "transparent";
            let fontWeight = "normal";
            
            if(pkt.type_str === "MGMT") {
                if(pkt.subtype_str.includes("BEACON")) color = "#a380ff";
                else if(pkt.subtype_str.includes("PROBE")) color = "#ff80ea";
                else color = "#e0c0ff";
            }
            else if(pkt.type_str === "DATA") {
                color = "#80b3ff";
            }
            else if(pkt.type_str === "EAPOL") {
                color = "#ffd700";
                bgColor = "rgba(255, 215, 0, 0.1)";
                fontWeight = "bold";
            }
            else if(pkt.type_str === "CTRL") {
                color = "#888";
            }

            row.style.color = color;
            row.style.backgroundColor = bgColor;
            row.style.fontWeight = fontWeight;

            let rssiColor = pkt.rssi > -60 ? "#0f0" : (pkt.rssi > -80 ? "#ff0" : "#f00");

            // --- QUI C'È LA MODIFICA PER LE 2 COLONNE ---
            row.innerHTML = `
                <td style="color:#fff">${pkt.ch}</td>
                <td style="color:${rssiColor}">${pkt.rssi}</td>
                
                <td style="font-size:0.75rem; font-weight:bold; opacity:0.7;">${pkt.type_str}</td>
                
                <td><span style="border:1px solid ${color}; padding:1px 4px; border-radius:3px; font-size:0.7rem;">${pkt.subtype_str}</span></td>
                
                <td>${pkt.src}</td>
                <td>${pkt.dst}</td>
                <td style="color:#aaa;">${pkt.len}</td>
                <td style="font-size:0.75rem; white-space:nowrap;">${pkt.info}</td>
            `;
            
            tbody.insertBefore(row, tbody.firstChild);
            
            if(tbody.children.length > 200) {
                tbody.removeChild(tbody.lastChild);
            }
            
            updateCounters();
        }
        
        function populateChannels() {
            const sel = document.getElementById('sniff-chan');
            if(!sel) return;
            sel.innerHTML = "";
            
            // 2.4 GHz Channels
            let grp24 = document.createElement('optgroup');
            grp24.label = "2.4 GHz";
            for(let i=1; i<=14; i++) {
                let opt = document.createElement('option');
                opt.value = i; 
                opt.innerText = "CH " + i;
                grp24.appendChild(opt);
            }
            sel.appendChild(grp24);

            // 5 GHz Channels (Common ones)
            let grp5 = document.createElement('optgroup');
            grp5.label = "5 GHz";
            const ch5 = [36, 40, 44, 48, 52, 56, 60, 64, 100, 104, 108, 112, 116, 120, 124, 128, 132, 136, 140, 144, 149, 153, 157, 161, 165];
            ch5.forEach(c => {
                let opt = document.createElement('option');
                opt.value = c; 
                opt.innerText = "CH " + c;
                grp5.appendChild(opt);
            });
            sel.appendChild(grp5);
        }
        
        function togglePause() {
            isSnifferPaused = !isSnifferPaused;
            const btn = document.getElementById('btn-sniff-pause');
            if(isSnifferPaused) {
                btn.innerText = "恢复视图";
                btn.style.border = "1px solid var(--accent)";
                btn.style.color = "var(--accent)";
            } else {
                btn.innerText = "暂停视图";
                btn.style.border = "1px solid #444";
                btn.style.color = "white";
            }
        }
        
        function clearSnifferTable() {
            document.getElementById('sniffer-body').innerHTML = "";
            totalPacketsRx = 0;
            displayedPackets = 0;
            updateCounters();
        }

        function updateCounters() {
            const totEl = document.getElementById('pkt-total-count');
            const dispEl = document.getElementById('pkt-display-count');
            if(totEl) totEl.innerText = totalPacketsRx;
            if(dispEl) dispEl.innerText = displayedPackets;
        }
        
        function updateSubtypes() {
            const type = document.getElementById('sniff-type').value;
            const subSel = document.getElementById('sniff-subtype');
            subSel.innerHTML = "";
            subSel.disabled = false;

            if (type == "0") {
                let opt = document.createElement('option');
                opt.value = 0; opt.innerText = "All Subtypes";
                subSel.appendChild(opt);
                subSel.disabled = true;
                return;
            }

            if (SUBTYPES[type]) {
                SUBTYPES[type].forEach(st => {
                    let opt = document.createElement('option');
                    opt.value = st.val;
                    opt.innerText = st.name;
                    subSel.appendChild(opt);
                });
            }
        }

        // ==========================================
        // WEBSOCKET ENGINE (IL CUORE DEL SISTEMA)
        // ==========================================
        function connectWS() {
            log("正在连接到 WebSocket...", "info");
            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                isConnected = true;
                log("WebSocket 已连接！", "info");
                showToast("系统在线");
                if (statusInterval) clearInterval(statusInterval);
                document.querySelector('.top-bar').style.borderBottom = "1px solid var(--border)";
                statusInterval = setInterval(requestSystemStatus, 2000);
            };

            ws.onclose = () => {
                isConnected = false;
                log("连接丢失（频道切换？）。正在重新连接 WiFi...", "error");
                showToast("连接断开 - 检查 WiFi");
                document.querySelector('.top-bar').style.borderBottom = "2px solid var(--danger)";
                setTimeout(connectWS, 3000);
            };

            ws.onerror = (err) => {
                console.error("WS 错误:", err);
                ws.close();
            };

            ws.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);

                    // 数据包嗅探器
                    if (msg.type === 'packet') {
                        handlePacket(msg); 
                        return;
                    }

                    // 服务器日志
                    if (msg.type === 'log') {
                        log(msg.msg, msg.level);
                        return;
                    }
                    if (msg.req_id && pendingRequests.has(msg.req_id)) {
                        const { resolve, reject } = pendingRequests.get(msg.req_id);
                        if (msg.status === 'error') {
                            reject(msg.message || "未知错误");
                        } else {
                            resolve(msg);
                        }
                        pendingRequests.delete(msg.req_id);
                    }
                } catch (e) {
                    console.error("JSON 解析错误:", e);
                }
            };
        }

        /**
         * 通过 WebSocket 发送命令并返回 Promise。
         * 使用方法: const dati = await sendCommand(CMD.WIFI_SCAN);
         */
        function sendCommand(cmdId, params = {}) {
            return new Promise((resolve, reject) => {
                if (!isConnected) {
                    reject("WebSocket 未连接");
                    return;
                }
                const id = ++reqIdCounter;
                pendingRequests.set(id, { resolve, reject });
                const payload = JSON.stringify({
                    cmd: cmdId,
                    req_id: id,
                    ...params
                });
                ws.send(payload);
                // 安全超时：如果 ESP 在 15 秒内未响应，取消
                setTimeout(() => {
                    if (pendingRequests.has(id)) {
                        pendingRequests.delete(id);
                        reject("ESP32 超时");
                    }
                }, 10000); 
            });
        }

        // ==========================================
        // FUNZIONI API (STATUS, SCAN, ETC.)
        // ==========================================
        async function requestSystemStatus() {
            if (!isConnected) return;
            try {
                const data = await sendCommand(CMD.GET_STATUS);
                
                // 1. 顶部栏（RAM 和运行时间）
                if (data.uptime) document.getElementById('uptime-val').innerText = data.uptime;
                if (data.ram !== undefined) {
                    document.getElementById('ram-text-val').innerText = data.ram + '%';
                    const bar = document.getElementById('ram-bar');
                    bar.style.width = data.ram + '%';
                    bar.style.backgroundColor = data.ram > 85 ? 'var(--danger)' : 'var(--accent)';
                }

                // 2. 模块状态指示器和全局徽章
                const modEt = document.getElementById('mod-et');
                const modDeauth = document.getElementById('mod-deauth');
                const modKarma = document.getElementById('mod-karma');
                const globalBadge = document.getElementById('global-status-badge');

                // 重置样式
                const setInactive = (el, label) => {
                    el.style.borderColor = "#333";
                    el.querySelector('.mod-status').innerText = "未激活";
                    el.querySelector('.mod-status').style.color = "#444";
                };
                const setActive = (el, label, color) => {
                    el.style.borderColor = color;
                    el.querySelector('.mod-status').innerText = "运行中";
                    el.querySelector('.mod-status').style.color = color;
                    el.querySelector('.mod-status').style.textShadow = `0 0 10px ${color}`;
                };

                setInactive(modEt);
                setInactive(modDeauth);
                setInactive(modKarma);

                let activeModules = [];

                if(data.et_running) {
                    setActive(modEt, "邪恶孪生", "var(--accent)");
                    activeModules.push("邪恶孪生");
                }
                if(data.deauth_running) {
                    setActive(modDeauth, "断开认证", "var(--danger)");
                    activeModules.push("断开认证");
                }
                if(data.karma_running) {
                    setActive(modKarma, "因果", "#e040fb"); // 因果用紫色
                    activeModules.push("因果");
                }

                // 更新全局徽章
                if(activeModules.length > 0) {
                    globalBadge.innerText = activeModules.join(" + ");
                    globalBadge.style.borderColor = "var(--accent)";
                    globalBadge.style.color = "#fff";
                    globalBadge.style.background = "rgba(0, 230, 118, 0.1)";
                    globalBadge.style.boxShadow = "0 0 10px rgba(0,0,0,0.5)";
                } else {
                    globalBadge.innerText = "系统已就绪";
                    globalBadge.style.borderColor = "#444";
                    globalBadge.style.color = "#aaa";
                    globalBadge.style.background = "#333";
                    globalBadge.style.boxShadow = "none";
                }

                // 3. 目标档案数据
                // 如果 ET 运行中或者我们在内存中有选择的目标，则填充数据
                if (data.et_running) {
                    document.getElementById('home-ssid').innerText = data.ssid || "未知";
                    document.getElementById('home-bssid').innerText = data.bssid || "--";
                    document.getElementById('home-ch').innerText = data.ch || "--";
                    document.getElementById('home-vendor').innerText = data.vendor || "未知";
                    document.getElementById('home-auth').innerText = data.auth || "开放";
                    
                    const rssi = data.rssi || -100;
                    const rssiEl = document.getElementById('home-rssi');
                    rssiEl.innerText = rssi + " dBm";
                    rssiEl.style.color = rssi > -60 ? "#0f0" : (rssi > -80 ? "#ffab40" : "#ff5252");

                    // 5GHz 徽章
                    const badge5g = document.getElementById('home-5g-badge');
                    if (data.has_5g) {
                        badge5g.innerHTML = `检测到 信道 ${data.ch_5g}`;
                        badge5g.style.background = "rgba(0, 188, 212, 0.2)";
                        badge5g.style.color = "#00bcd4";
                        badge5g.style.border = "1px solid #00bcd4";
                    } else {
                        badge5g.innerText = "未找到";
                        badge5g.style.background = "#222";
                        badge5g.style.color = "#555";
                        badge5g.style.border = "1px solid transparent";
                    }

                } else if (!data.et_running && currentTarget) {
                     // 即使攻击未运行，也显示 JS 内存中的选定目标
                    document.getElementById('home-ssid').innerText = currentTarget.ssid;
                    document.getElementById('home-bssid').innerText = currentTarget.bssid;
                    document.getElementById('home-ch').innerText = currentTarget.channel;
                    document.getElementById('home-auth').innerText = "已选择";
                    document.getElementById('home-rssi').innerText = currentTarget.signal + " dBm";
                } else {
                    // 如果空闲且无选择，则重置
                    document.getElementById('home-ssid').innerText = "未选择目标";
                    document.getElementById('home-bssid').innerText = "--:--:--:--:--:--";
                    document.getElementById('home-ch').innerText = "--";
                    document.getElementById('home-vendor').innerText = "--";
                    document.getElementById('home-auth').innerText = "--";
                    document.getElementById('home-rssi').innerText = "-- dBm";
                }

                // 4. 握手徽章
                const hsBadge = document.getElementById('home-hs-badge');
                if (data.hs_state === 2) { 
                    hsBadge.innerText = "已捕获 (4-路)";
                    hsBadge.style.background = "rgba(0, 230, 118, 0.2)";
                    hsBadge.style.color = "var(--accent)";
                    hsBadge.style.border = "1px solid var(--accent)";
                } else if (data.hs_state === 1) { 
                    hsBadge.innerText = "已捕获 (PMKID)";
                    hsBadge.style.background = "rgba(255, 171, 64, 0.2)";
                    hsBadge.style.color = "#ffab40";
                    hsBadge.style.border = "1px solid #ffab40";
                } else {
                    hsBadge.innerText = "等待";
                    hsBadge.style.background = "#222";
                    hsBadge.style.color = "#555";
                    hsBadge.style.border = "1px solid transparent";
                }

                // 5. 环境统计数据
                document.getElementById('home-clients').innerText = data.n_clients || 0;
                document.getElementById('home-aps').innerText = data.n_aps || 0;

                // 6. 帧统计（新卡）
                // 确保在 server_api.c 中使用了 "tx_sent" 和 "tx_drop"
                const txSent = data.tx_sent || 0;
                const txDrop = data.tx_drop || 0;
                const totalTx = txSent + txDrop;

                // 更新数字
                document.getElementById('stat-tx-sent').innerText = formatBigNumber(txSent);
                document.getElementById('stat-tx-drop').innerText = formatBigNumber(txDrop);

                // 计算健康状况（发送质量）
                let quality = 100;
                let msg = "最优性能。";
                let color = "#00e676"; // 绿色

                if (totalTx > 0) {
                    quality = Math.round((txSent / totalTx) * 100);
                }

                // 颜色和消息逻辑
                if (quality < 50) {
                    color = "#ff1744"; // 关键红色
                    msg = "严重错误：无线电拥塞或驱动程序卡住。";
                } else if (quality < 80) {
                    color = "#ff9100"; // 橙色
                    msg = "警告：检测到高丢包率。";
                } else if (totalTx > 1000) {
                    msg = "正在注射包...";
                } else {
                    msg = "系统空闲 / 流量低。";
                }

                // 更新条形和文本
                document.getElementById('stat-quality-perc').innerText = quality + "%";
                document.getElementById('stat-quality-bar').style.width = quality + "%";
                document.getElementById('stat-quality-bar').style.backgroundColor = color;
                document.getElementById('stat-message').innerText = msg;
                document.getElementById('stat-message').style.color = (quality < 80) ? color : "#666";

                // SD 检查
                const sdEl = document.getElementById('status-sd');
                if (data.sd !== undefined) {
                    sdEl.innerText = data.sd ? "记录中" : "错误";
                    sdEl.style.color = data.sd ? "var(--accent)" : "var(--danger)";
                }

            } catch (e) {
                console.error(e);
            }
        }

        async function scanNetworks() {
            log("正在启动 WiFi 扫描 (WS)...");
            const tbody = document.getElementById('wifi-networks-body');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:var(--accent);">扫描进行中...</td></tr>';
            
            try {
                const response = await sendCommand(CMD.WIFI_SCAN);
                const networks = response.data; 

                tbody.innerHTML = '';
                if (!networks || networks.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">未找到网络</td></tr>';
                    return;
                }

                networks.sort((a, b) => b.signal - a.signal);
                networks.forEach(net => {
                    const tr = document.createElement('tr');
                    const safeSsid = net.ssid.replace(/'/g, "\\'");
                    
                    tr.innerHTML = `
                        <td style="font-weight:bold; color:white;">${net.ssid}</td>
                        <td>${net.signal}</td>
                        <td>${net.channel}</td>
                        <td style="font-family:monospace; font-size:0.85rem;">${net.bssid}</td>
                        <td>${net.authmode}</td> <td>
                            <button style="margin:0; padding:6px 10px; font-size:0.7rem;" 
                                onclick="selectTarget('${safeSsid}', '${net.bssid}', ${net.channel}, ${net.signal}, ${net.authmode_code})">
                                目标
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                log(`扫描完成。找到 ${networks.length} 个 AP。`);
            } catch (err) {
                log(`扫描错误: ${err}`, "error");
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:var(--danger);">扫描失败</td></tr>';
            }
        }

        async function loadApSettings() {
            try {
                const data = await sendCommand(CMD.GET_AP_SETTINGS);
                document.getElementById('ssid').value = data.ssid || '';
                document.getElementById('password').value = data.password || '';
                document.getElementById('channel').value = data.channel || 1;
            } catch (err) {
                log("加载设置错误: " + err, "error");
            }
        }

        async function handleSettings(e) {
            e.preventDefault();
            const ssid = document.getElementById('ssid').value;
            const password = document.getElementById('password').value;
            const channel = parseInt(document.getElementById('channel').value);

            try {
                showToast("保存中...");
                const res = await sendCommand(CMD.SET_AP_SETTINGS, { ssid, password, channel });
                if(res.status === "ok") {
                    showToast("设置已保存！");
                    log("AP 设置更新成功。");
                }
            } catch (err) {
                showToast("保存设置时出错");
                log("保存错误: " + err, "error");
            }
        }

        function selectTarget(ssid, bssid, channel, signal, authmode) {
            currentTarget = { ssid, bssid, channel, signal, authmode };
            document.getElementById('current-target-ssid').innerText = ssid;
            document.getElementById('current-target-bssid').innerText = bssid;
            document.getElementById('home-target').innerText = ssid;
            showToast(`已选择目标: ${ssid}`);
            
            const evilTwinMenu = document.querySelectorAll('.menu-item')[2];
            showView('view-eviltwin', evilTwinMenu);
            if(document.getElementById('view-deauth').classList.contains('active')) updateDeauthUI();
        }

        function updateDeauthUI() {
            const mode = document.getElementById('deauth-mode').value;
            const ssidEl = document.getElementById('deauth-target-ssid');
            const bssidEl = document.getElementById('deauth-target-bssid');
            const chEl = document.getElementById('deauth-target-ch');
            const warnEl = document.getElementById('deauth-warning-text');

            if (mode === 'broadcast') {
                ssidEl.innerText = "所有网络（广播）";
                ssidEl.style.color = "#ffab40";
                bssidEl.innerText = "FF:FF:FF:FF:FF:FF";
                chEl.innerText = "跳跃（所有频道）";
                warnEl.innerText = "这将断开所有附近网络上的所有设备。极其嘈杂！";
            } else {
                // 如果存在，恢复选定的目标
                ssidEl.style.color = "white";
                warnEl.innerText = "这将断开客户端与所选接入点的连接。";
                if (currentTarget) {
                    ssidEl.innerText = currentTarget.ssid;
                    bssidEl.innerText = currentTarget.bssid;
                    chEl.innerText = currentTarget.channel;
                } else {
                    ssidEl.innerText = "未选择目标";
                    bssidEl.innerText = "--:--:--:--:--:--";
                    chEl.innerText = "--";
                }
            }
        }

        async function startEvilTwin() {
            if (!currentTarget) {
                showToast("未选择目标！");
                return;
            }
            log(`在 ${currentTarget.ssid} 上启动邪恶孪生...`);
            const params = {
                ssid: currentTarget.ssid,
                bssid: currentTarget.bssid,
                channel: currentTarget.channel,
                signal: currentTarget.signal,
                authmode_code: currentTarget.authmode,
                scheme: parseInt(document.getElementById('attack-scenario').value)
            };

            try {
                const res = await sendCommand(CMD.START_EVILTWIN, params);
                if(res.status === 'ok') {
                    showToast("邪恶孪生已启动！");
                }
            } catch(e) {
                log("启动攻击错误: " + e, "error");
            }
        }

        async function stopEvilTwin() {
            /*if(confirm("To stop the Evil Twin fully, the device usually needs a reset or a specific command. Reload page?")) {
                location.reload();
            }*/
            log(`停止邪恶孪生攻击...`);

            try {
                const res = await sendCommand(CMD.STOP_EVILTWIN);
                if(res.status === 'ok') {
                    showToast("邪恶孪生攻击已停止！");
                }
            } catch(e) {
                log("停止攻击错误: " + e, "error");
            }
        }

        async function startKarmaScan() {
            log("正在启动因果扫描...");
            try {
                await sendCommand(CMD.KARMA_ATTACK_SCAN, { start_stop: 1 });
                showToast("正在扫描探针...");
                if(karmaInterval) clearInterval(karmaInterval);
                karmaInterval = setInterval(fetchKarmaProbes, 4000);
            } catch(e) {
                log("启动扫描错误: " + e, "error");
            }
        }

        async function stopKarmaScan() {
            log("停止因果扫描...");
            try {
                await sendCommand(CMD.KARMA_ATTACK_SCAN, { start_stop: 0 });
                showToast("扫描已停止");
                if(karmaInterval) clearInterval(karmaInterval);
            } catch(e) { log("停止扫描错误: " + e, "error"); }
        }

        async function fetchKarmaProbes() {
            try {
                const res = await sendCommand(CMD.GET_KARMA_PROBES);
                const data = res.data;
                
                const tbody = document.getElementById('karma-scan-body');
                tbody.innerHTML = '';

                if(!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#666;">正在监听...</td></tr>';
                    return;
                }

                data.forEach(p => {
                     const tr = document.createElement('tr');
                     const safeSsid = p.ssid.replace(/'/g, "\\'");
                     tr.innerHTML = `
                        <td style="font-family:monospace; color:#aaa;">${p.mac}</td>
                        <td style="font-weight:bold; color:white;">${p.ssid}</td>
                        <td>${p.rssi}</td>
                        <td>${p.channel}</td>
                        <td>
                            <button class="danger" style="padding:4px 8px; font-size:0.7rem;"
                                onclick="launchKarmaAttack('${safeSsid}', ${p.channel})">攻击</button>
                        </td>
                     `;
                     tbody.appendChild(tr);
                });
            } catch(e) { }
        }

        async function launchKarmaAttack(ssid, channel) {
            const scenario = parseInt(document.getElementById('karma-scenario').value);
            if(confirm(`攻击 ${ssid}?`)) {
                try {
                    await sendCommand(CMD.KARMA_ATTACK_START, {
                        ssid: ssid,
                        channel: channel,
                        scheme: scenario
                    });
                    showToast(`因果已在 ${ssid} 上启动`);
                } catch(e) {
                    log("启动因果错误: " + e, "error");
                }
            }
        }

        async function fetchPasswords() {
            const area = document.getElementById('passwords-textarea');
            area.value = "获取中...";
            try {
                const res = await sendCommand(CMD.GET_PASSWORDS);
                if(res.content) {
                    area.value = res.content;
                } else {
                    area.value = "(未找到密码或文件为空)";
                }
            } catch(e) {
                area.value = "连接错误: " + e;
            }
        }

        async function startDeauth() {
            const mode = document.getElementById('deauth-mode').value;
            const selectEl = document.getElementById('deauth-frame-type');
            const frameType = parseInt(selectEl.value);
            const attackName = selectEl.options[selectEl.selectedIndex].text;
            let targetBssid = "";
            let targetChannel = 0;
            let targetSsid = "";

            if (mode === 'broadcast') {
                targetBssid = "FF:FF:FF:FF:FF:FF";
                targetChannel = 0;
                log(`启动广播攻击 (类型: ${attackName})...`, "warning");
            } else {
                if (!currentTarget) {
                    showToast("错误：未选择目标！");
                    return;
                }
                targetBssid = currentTarget.bssid;
                targetChannel = currentTarget.channel;
                targetSsid = currentTarget.ssid;
                log(`在 ${currentTarget.ssid} 上启动攻击 (类型: ${attackName})...`, "warning");
            }
            
            try {
                const res = await sendCommand(CMD.START_DEAUTHER, {
                    ssid: targetSsid,
                    bssid: targetBssid,
                    channel: targetChannel,
                    mode: mode,
                    packet_type: frameType
                });
                
                if(res.status === 'ok') {
                    showToast("攻击已启动");
                } else {
                    showToast("启动攻击出错");
                    log("服务器错误: " + res.message, "error");
                }
            } catch(e) {
                log("启动断开认证错误: " + e, "error");
            }
        }
        
        async function stopDeauth() {
            try {
                log("停止断开认证攻击... 请稍候...", "warning");
                await sendCommand(CMD.STOP_DEAUTHER);
                showToast("攻击已停止");
                log("断开认证攻击已停止。", "success");
            } catch(e) {
                log("停止错误: " + e, "error");
            }
        }
        
        function startCapture() {
            const btnStart = document.getElementById('btn-sniff-start');
            const btnStop = document.getElementById('btn-sniff-stop');
            
            // 检索 UI 参数
            const type = parseInt(document.getElementById('sniff-type').value);
            // 注意：子类型的值可以很大（位掩码），对 JS 没关系
            const subtype = parseInt(document.getElementById('sniff-subtype').value);
            const channel = parseInt(document.getElementById('sniff-chan').value);
            const hopping = document.getElementById('sniff-hop').checked;

            log(`启动嗅探器: CH=${hopping?'跳跃':channel}, 类型=${type}, 子=${subtype}`, "info");

            // 向后端发送命令 (CMD.START_RAW_SNIFFER = 14)
            sendCommand(CMD.START_RAW_SNIFFER, { 
                type: type,
                subtype: subtype,
                channel: channel,
                hopping: hopping
            }).then(() => {
                snifferActive = true;
                showToast("嗅探器已启动");
                
                // 禁用控件并更新按钮
                btnStart.disabled = true;
                btnStart.style.opacity = "0.5";
                btnStart.style.cursor = "not-allowed";
                
                btnStop.disabled = false;
                btnStop.style.opacity = "1";
                btnStop.style.cursor = "pointer";

                document.getElementById('sniff-chan').disabled = true;
                document.getElementById('sniff-hop').disabled = true;
                document.getElementById('sniff-type').disabled = true;
                document.getElementById('sniff-subtype').disabled = true;
            }).catch(err => {
                showToast("启动出错: " + err);
                log("嗅探器启动错误: " + err, "error");
            });
        }

        function stopCapture() {
            const btnStart = document.getElementById('btn-sniff-start');
            const btnStop = document.getElementById('btn-sniff-stop');

            sendCommand(CMD.STOP_RAW_SNIFFER).then(() => {
                snifferActive = false;
                showToast("嗅探器已停止");
                log("数据包嗅探器已停止。", "warning");

                // 解锁按钮和控件
                btnStart.disabled = false;
                btnStart.style.opacity = "1";
                btnStart.style.cursor = "pointer";
                
                btnStop.disabled = true;
                btnStop.style.opacity = "0.5";
                btnStop.style.cursor = "not-allowed";

                document.getElementById('sniff-chan').disabled = false;
                document.getElementById('sniff-hop').disabled = false;
                document.getElementById('sniff-type').disabled = false;
                document.getElementById('sniff-subtype').disabled = false;
                
                // 更新子类型状态
                updateSubtypes();
            });
        }
        // ==========================================
        // 初始化
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            connectWS();
            updateAttackTypeDesc();
            populateChannels();
            log("系统 UI 已初始化。");
        });

    </script>
</body>
</html>