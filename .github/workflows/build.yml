name: Build ESP32-S3 Full Flashable Firmware

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Python and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install platformio esptool

      - name: Build Firmware for ESP32-S3
        run: |
          pio run -e esp32s3 -v
          # 打包 SPIFFS
          pio run -e esp32s3 --target buildfs

      - name: Generate Full Flashable Bin
        run: |
          mkdir merged_bin
          # 从 PlatformIO 的 partition table 自动读取 SPIFFS 起始地址
          PARTITION_BIN=".pio/build/esp32s3/partition-table.bin"
          SPIFFS_BIN=".pio/build/esp32s3/spiffs.bin"
          APP_BIN=".pio/build/esp32s3/firmware.bin"
          BOOTLOADER_BIN=".pio/build/esp32s3/bootloader.bin"

          # 使用 esptool.py merge_bin 合并成单文件
          # 这里假设 partition-table.bin 内定义的 SPIFFS 偏移是 0x290000（可根据实际表修改）
          esptool.py merge_bin \
            -o merged_bin/esp32s3_full.bin \
            0x1000 $BOOTLOADER_BIN \
            0x8000 $PARTITION_BIN \
            0x10000 $APP_BIN \
            0x290000 $SPIFFS_BIN

      - name: Upload Merged Firmware
        uses: actions/upload-artifact@v3
        with:
          name: esp32s3-full-flashable
          path: merged_bin/esp32s3_full.bin