name: Build Firmware for ESP32S3

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PlatformIO
        uses: platformio/action-setup@v2

      - name: Install dependencies
        run: |
          python3 -m pip install -U platformio

      - name: Build firmware
        run: |
          pio run -e esp32s3
          
      - name: Create merged firmware
        run: |
          # Create merged.bin including bootloader, partitions and app
          esptool.py --chip esp32s3 merge_bin -o merged.bin \
            --flash_mode dio --flash_size 8MB --flash_freq 80m \
            0x0 .pio/build/esp32s3/bootloader.bin \
            0x8000 .pio/build/esp32s3/partition-table.bin \
            0x10000 .pio/build/esp32s3/firmware.bin

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: esp32s3-firmware
          path: merged.bin
