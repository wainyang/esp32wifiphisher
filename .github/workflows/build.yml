name: Build ESP32-S3 Full Flashable Firmware

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Python and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install platformio esptool

      - name: Build Firmware for ESP32-S3
        run: |
          pio run -e esp32s3 -v
          # 打包 SPIFFS
          pio run -e esp32s3 --target buildfs

      - name: Generate Full Flashable Bin
        run: |
          mkdir merged_bin
          BOOTLOADER_BIN=".pio/build/esp32s3/bootloader.bin"
          PARTITION_BIN=".pio/build/esp32s3/partition-table.bin"
          APP_BIN=".pio/build/esp32s3/firmware.bin"
          SPIFFS_BIN=".pio/build/esp32s3/spiffs.bin"

          # 自动解析 partition table 获取 SPIFFS 起始地址
          SPIFFS_OFFSET=$(python3 - <<'EOF'
import sys
filename = ".pio/build/esp32s3/partition-table.bin"
with open(filename, "rb") as f:
    data = f.read()
# partition table 每条记录 32 bytes，类型 0x01 = app, 0x02 = data, subtype 0x82 = SPIFFS
SPIFFS_START = None
for i in range(0, len(data), 32):
    part_type = data[i]
    part_subtype = data[i+1]
    offset = int.from_bytes(data[i+2:i+6], "little")
    if part_type == 0x01 and part_subtype == 0x82:  # SPIFFS 在某些项目 subtype 0x82
        SPIFFS_START = offset
        break
    # ESP32S3 默认 data subtype = 0x82（SPIFFS）
    if part_type == 0x02 and part_subtype == 0x82:
        SPIFFS_START = offset
        break
if SPIFFS_START is None:
    print("0x290000")  # 默认 fallback
else:
    print(hex(SPIFFS_START))
EOF
)

          echo "SPIFFS offset: $SPIFFS_OFFSET"

          # 合并 bin
          esptool.py merge_bin \
            -o merged_bin/esp32s3_full.bin \
            0x1000 $BOOTLOADER_BIN \
            0x8000 $PARTITION_BIN \
            0x10000 $APP_BIN \
            $SPIFFS_OFFSET $SPIFFS_BIN

      - name: Upload Merged Firmware
        uses: actions/upload-artifact@v3
        with:
          name: esp32s3-full-flashable
          path: merged_bin/esp32s3_full.bin